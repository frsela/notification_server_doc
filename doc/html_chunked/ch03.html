<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>Chapter 3. Notification server API</title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Notification Server"><link rel="up" href="index.html" title="Notification Server"><link rel="prev" href="ch02s06.html" title="Mobile Network. Battery comsuption"><link rel="next" href="ch03s02.html" title="API between the User Agent and the Notification Server"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter 3. Notification server API</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch02s06.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="ch03s02.html">Next</a></td></tr></table><hr></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="api"></a>Chapter 3. Notification server API</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="ch03.html#api_wa_ua">API between WebApp and the User Agent</a></span></dt><dt><span class="section"><a href="ch03s02.html">API between the User Agent and the Notification Server</a></span></dt><dt><span class="section"><a href="ch03s03.html">API between the Application Server and the Notification Server</a></span></dt><dd><dl><dt><span class="section"><a href="ch03s03.html#idp50071584">Generic API</a></span></dt><dt><span class="section"><a href="ch03s03.html#api_as_ns_simplepush">Simple PUSH API</a></span></dt></dl></dd><dt><span class="section"><a href="ch03s04.html">API between the WA and the AS</a></span></dt><dt><span class="section"><a href="ch03s05.html">Tokens</a></span></dt><dd><dl><dt><span class="section"><a href="ch03s05.html#idp50095216">channelID</a></span></dt><dt><span class="section"><a href="ch03s05.html#idp50102064">UAID</a></span></dt><dt><span class="section"><a href="ch03s05.html#idp50104080">endpointURL</a></span></dt></dl></dd><dt><span class="section"><a href="ch03s06.html">WakeUp</a></span></dt><dd><dl><dt><span class="section"><a href="ch03s06.html#idp50109504">status</a></span></dt><dt><span class="section"><a href="ch03s06.html#idp50114992">Wake up method</a></span></dt></dl></dd></dl></div><p>
    The Notification Server API is based on the W3C draft:
    <a class="link" href="http://dvcs.w3.org/hg/push/raw-file/default/index.html" target="_top">
      [http://dvcs.w3.org/hg/push/raw-file/default/index.html]
    </a>
  </p><p>
    In order to understand this chapter, we'll present the different actors:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
        WebApp (WA):
        <p>
          The user's applications which is normally executed on the
          user device.
        </p></li><li class="listitem">
        User Agent (UA):
        <p>
          Since this protocol born under the Firefox OS umbrella the
          "operating system" layer is known as the User Agent layer, in our case
          is the Gecko engine.
        </p></li><li class="listitem">
        Notification Server (NS):
        <p>
          Centralized infrastructure of the notification
          server platform. This one can be freely deployed by anyone since it's
          open source:
          <a class="link" href="https://github.com/telefonicaid/notification_server" target="_top">
            [https://github.com/telefonicaid/notification_server]
          </a>.
          The protocol also allows to use any server infrastructure the user wants
        </p></li><li class="listitem">
        Application server (AS):
        <p>
          The WA server side. Normally the applications that runs on a
          mobile device use one or more Internet servers.
        </p><p>
          Some of them will be deployed by the same developer as the client application.
        </p><p>
          In our case, this server will be the one which send the notification to
          his clients/users.
        </p></li></ul></div><p>
  </p><p>
    </p><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="450"><tr><td align="center"><img src="resources/actors_and_channels.png" align="middle" width="450"></td></tr></table><p>
  </p><p>
    The following sequence diagram shows a tipical message flow between actors:
  </p><p>
    </p><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="496"><tr><td align="center"><img src="resources/ns-arch-en.png" align="middle" width="496"></td></tr></table><p>
  </p><div lang="en" class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="api_wa_ua"></a>API between WebApp and the User Agent</h2></div></div></div><p>
    This API is mainly based on the W3C draft as specified in
    <a class="link" href="http://dvcs.w3.org/hg/push/raw-file/default/index.html" target="_top">
      [http://dvcs.w3.org/hg/push/raw-file/default/index.html]
    </a>
  </p><p>
    Also there is more information about Simple PUSH API here:
    <a class="link" href="https://wiki.mozilla.org/WebAPI/SimplePush" target="_top">
      [https://wiki.mozilla.org/WebAPI/SimplePush]
    </a>
  </p><p>
    With this API the application is able to register notification
    channels itself into the Notification Server and recover the public URL
    to be used as the notification endpointURL by his Application Server (AS).
  </p><p>
    This API (under the navigator.push object) defines these methods:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
        register
      </li><li class="listitem">
        unregister
      </li><li class="listitem">
        registrations
      </li></ul></div><p>
    </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="idp49927680"></a>navigator.push.register</h4></div></div></div><p>
        This method allows the application to register a new channel.
        </p><pre class="programlisting">
        
        navigator.push.register()
        
        </pre><p>
      </p><p>
        Finally this method will response asynchronously with the URL to be
        sent to the AS in order to be able to send notifications.
      </p><pre class="programlisting">
        
        var req = navigator.push.register();
        req.onsuccess = function(e) {
          alert("Received URL: " + req.result.pushEndpoint);
        };
        req.onerror = function(e) {
          alert("Error registering app");
        }
        
      </pre></div><p>

    </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="idp49867408"></a>navigator.push.unregister</h4></div></div></div><p>
        This method allows the application to unregister a previously registered
        channel.
      </p><pre class="programlisting">
        
        navigator.push.unregister(endPointURL);
        
      </pre></div><p>
  </p><p>
    After register the application into the Notification Server, all received
    notification through the given URL will be delivered to the WA registered
    channel.
  </p><p>
    Since the notifications will be received by the UA it's needed a way to
    notify each application. The current specification is using the new
    System Messages infrastructure defined in FirefoxOS.
  </p><p>
    In this case, the application shall register to the "push-notification"
    event handler:
    </p><pre class="programlisting">
    
    navigator.mozSetMessageHandler("push", function(msg) {
      alert("New Message with body: " + JSON.stringify(msg));
    });
    
    </pre><p>
  </p><p>
    Inside the msg you'll receive the pushEndpoint URL so an app can register
    as many channels as it wants and with this attribute has a chance to
    differenciate one from another.
  </p><p>
    The complete example:
    </p><pre class="programlisting">
      
        var emailEndpoint, imEndpoint;

        // The user has logged in, now's a good time to register the channels
        MyAppFramework.addEventListener('user-login', function() {
          setupAppRegistrations();
        });

        function setupAppRegistrations() {
         // Issue a register() call
         // to register to listen for a notification,
         // you simply call push.register
         // Here, we'll register a channel for "email" updates.
         // Channels can be for anything the app would like to get notifications for.
         var reqEmail = navigator.push.register();
         reqEmail.onsuccess = function(e) {
           emailEndpoint = e.target.result.pushEndpoint;
           storeOnAppServer("email", emailEndpoint); // This is the "Hand wavey" way that the App 
                                                     // sends the endPoint back to the AppServer
         }

         // We'll also register a second channel for "im", because we're social and all about the socialists. Or something.
         var reqIm = navigator.push.register();
         reqIm.onsuccess = function(e) {
           imEndpoint = e.target.result.pushEndpoint;
           storeOnAppServer("im", imEndpoint);
         }
        }

        // Once we've registered, the AppServer can send version pings to the EndPoint.
        // This will trigger a 'push' message to be sent to this handler.
        navigator.mozSetMessageHandler('push', function handlePushMessage(message) {
          if (message.pushEndpoint == emailEndpoint)   // Yay! New Email! Steve and blue can dance!
            getNewEmailMessagesFromAppServer(message.version);
          else if (message.pushEndpoint == imEndpoint) // Yay! An IM awaits. I wonder if it's Sam's IM?
            getNewChatMessagesFromAppServer();
        });

        // to unregister, you simply call..
        AppFramework.addEventListener('user-logout', function() {
          navigator.push.unregister(emailEndpoint);
          navigator.push.unregister(imEndpoint);
        });
      
    </pre><p>
  </p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch02s06.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="ch03s02.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Mobile Network. Battery comsuption </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> API between the User Agent and the Notification Server</td></tr></table></div></body></html>
